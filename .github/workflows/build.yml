name: Build OpenWrt MT6000
permissions:
  contents: write
  actions: write

on:
  workflow_dispatch:

env:
  REMOTE_REPOSITORY: pesa1234/openwrt
  CONFIG_FILE: seed.config
  GH_TOKEN: ${{ github.token }}

jobs:
  build:
    name: Build OpenWrt
    runs-on: ubuntu-24.04-arm
    timeout-minutes: 350
    steps:
      - name: Free Disk Space
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential clang flex bison g++ gawk gettext libncurses-dev libssl-dev python3-setuptools rsync swig unzip zlib1g-dev file wget llvm jq

      - name: Get Remote Branch and SHA
        id: get_info
        run: |
          # 1. Get the latest branch name starting with 'next-'
          remote_branch=$(git ls-remote https://github.com/${{ env.REMOTE_REPOSITORY }}.git "refs/heads/next-*" | sed -e 's|\(.*heads/\)||' | grep -viE 'test|beta' | sort -V | tail -n1)
          
          # 2. FORCE API to look at this specific branch to get the REAL latest SHA
          # This uses the query parameter ?sha= to bypass any stale cache on GitHub's end
          latest_sha=$(gh api "repos/${{ env.REMOTE_REPOSITORY }}/commits?sha=${remote_branch}" --jq '.[0].sha')
          
          echo "branch=${remote_branch}" >> $GITHUB_OUTPUT
          echo "sha=${latest_sha}" >> $GITHUB_OUTPUT
          
          echo "Selected Branch: ${remote_branch}"
          echo "Selected SHA: ${latest_sha}"

      - name: Checkout remote repository
        uses: actions/checkout@v4
        with:
          repository: ${{ env.REMOTE_REPOSITORY }}
          # Use the SHA instead of the branch name to force the absolute latest code
          ref: ${{ steps.get_info.outputs.sha }}

      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          path: "builder_repo"

      - name: Update and install feeds
        run: |
          ./scripts/feeds update -a
          ./scripts/feeds install -a

      - name: Setup configuration and custom files
        run: |
          rm -frv builder_repo/.git builder_repo/.github
          
          echo "=== Replacing XXXXXX/YYYYYY with ${{ github.repository }} ==="
          for file in $(find builder_repo/ -type f -not -path '*/\.git/*' 2>/dev/null); do 
            if grep -q "XXXXXX/YYYYYY" "$file" 2>/dev/null; then
              echo "Modifying: $file"
              sed -i "s|XXXXXX/YYYYYY|${{ github.repository }}|g" "$file"
            fi
          done
          
          echo "=== Applying patch ==="
          patch -p1 < builder_repo/attendedsysupgrade-with-GitHub.patch || exit 1
          
          if [ -d builder_repo/files ]; then
            echo "=== Copying custom files ==="
            cp -rv builder_repo/files ./
          else
            echo "ERROR: builder_repo/files does not exist!"
            exit 1
          fi
          
          echo "=== Replacing XXXXXX/YYYYYY in files/ ==="
          find files/ -type f \( -name "github_*" -o -name "upgrade_custom_openwrt" -o -name "update_luci_command" -o -name "99-save-build-date" \) | while read file; do
            if grep -q "XXXXXX/YYYYYY" "$file" 2>/dev/null; then
              echo "Modifying copied file: $file"
              sed -i "s|XXXXXX/YYYYYY|${{ github.repository }}|g" "$file"
            fi
          done
          
          mv -v builder_repo/${{ env.CONFIG_FILE }} .config
          cp builder_repo/release_info.md . || echo "release_info.md not found"
          
          chmod -v 755 files/usr/bin/upgrade_custom_openwrt 2>/dev/null || true
          chmod -v 755 files/usr/bin/update_luci_command 2>/dev/null || true
          chmod -v 755 files/www/cgi-bin/github_* 2>/dev/null || true
          chmod -v 755 files/root/toggle_toronto.sh 2>/dev/null || true
          chmod +x files/root/update_agh.sh 2>/dev/null || true
          chmod -v 755 files/etc/uci-defaults/99-save-build-date 2>/dev/null || true
          
          echo "=== Checking for remaining placeholders ==="
          if grep -r "XXXXXX" files/www/cgi-bin/ files/usr/bin/ 2>/dev/null; then
            echo "ERROR: Placeholder XXXXXX STILL present!"
            exit 1
          fi
          
          rm -rfv builder_repo
          make defconfig

      - name: Download packages
        run: |
          make download -j$(nproc) || make download -j1 V=s

      - name: Compile the firmware
        run: |
          make -j$(nproc) || make -j1 V=s

      - name: Prepare Artifacts
        id: prepare
        run: |
          mkdir -p firmware
          ORIGINAL_FILE=$(find ./bin -type f -name "*sysupgrade.bin" 2>/dev/null | grep -E "mt6000|filogic" | head -n 1)
          
          if [ -z "$ORIGINAL_FILE" ]; then
            echo "ERROR: No sysupgrade file found!"
            exit 1
          fi
          
          cp -v "$ORIGINAL_FILE" ./firmware/
          find ./bin -name "version.buildinfo" -exec cp -v {} ./firmware/config.buildinfo \; 2>/dev/null || true
          cp .config ./firmware/config.seed
          
          cd firmware
          sha256sum * > sha256sums
          cd ..
          
          TAG="v-$(date -u +%Y.%m.%d-%H%M)"
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "=== Files ready for release ==="
          ls -lh firmware/

      - name: Delete old latest release
        continue-on-error: true
        run: |
          gh release delete latest --yes || true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Clean up old releases and tags
        continue-on-error: true
        run: |
          gh release list --limit 100 | grep -v "latest" | awk '{print $3}' | while read tag; do
            if [ ! -z "$tag" ]; then
              echo "Deleting release and tag: $tag"
              gh release delete "$tag" --yes || true
              git push origin :refs/tags/"$tag" || true
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_info.md
          files: |
            firmware/*
          tag_name: latest
          name: "Latest Build - ${{ steps.prepare.outputs.tag }}"
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
