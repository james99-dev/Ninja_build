#!/bin/sh
echo "=== VÃ©rification de mise Ã  jour disponible ==="
if [ -f /etc/release_build_date ]; then
    LOCAL_DATE=$(cat /etc/release_build_date)
    echo "Date locale : $LOCAL_DATE"
else
    LOCAL_DATE=""
    echo "Aucune date locale trouvÃ©e"
fi
RESPONSE=$(QUERY_STRING="tag=latest" /www/cgi-bin/github_check)
GITHUB_DATE=$(echo "$RESPONSE" | sed 's/Content-Type: application\/json//' | jq -r '.[0].updated_at // empty')
echo "Date GitHub : $GITHUB_DATE"
if [ -n "$LOCAL_DATE" ] && [ "$LOCAL_DATE" = "$GITHUB_DATE" ]; then
    echo "âœ… DÃ©jÃ  Ã  jour"
    exit 0
fi
echo "ğŸ”„ Nouvelle version dÃ©tectÃ©e!"
echo "TÃ©lÃ©chargement..."
FETCH_RESPONSE=$(QUERY_STRING="tag=latest" /www/cgi-bin/github_fetch)
if echo "$FETCH_RESPONSE" | grep -q '"success":true'; then
    echo "âœ… TÃ©lÃ©chargement rÃ©ussi!"
    echo "$GITHUB_DATE" > /etc/release_build_date
    echo "ğŸ“¦ Firmware dans /tmp/firmware.bin"
else
    echo "âŒ Erreur"
    exit 1
fi
